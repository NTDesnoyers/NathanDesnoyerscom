name: AI Code Review

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}...HEAD > /tmp/changed.txt
          else
            git diff --name-only HEAD~1 HEAD > /tmp/changed.txt || echo "" > /tmp/changed.txt
          fi
          echo "files=$(cat /tmp/changed.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT
          cat /tmp/changed.txt

      - name: Basic linting (JS/TS)
        if: contains(steps.changed.outputs.files, '.js') || contains(steps.changed.outputs.files, '.ts')
        run: |
          npm install -g eslint 2>/dev/null || true
          npx eslint --no-eslintrc -c '{"rules":{"no-eval":2,"no-unused-vars":1,"no-undef":1}}' \
            $(cat /tmp/changed.txt | grep -E '\.(js|ts|jsx|tsx)$' | tr '\n' ' ') 2>/dev/null || true

      - name: Basic linting (Python)
        if: contains(steps.changed.outputs.files, '.py')
        run: |
          pip install pyflakes 2>/dev/null
          cat /tmp/changed.txt | grep '\.py$' | xargs pyflakes 2>/dev/null || true

      - name: Security scan
        run: |
          # Check for common secrets/bad patterns
          echo "üîç Scanning for sensitive patterns..."
          ISSUES=0
          while IFS= read -r file; do
            [ -f "$file" ] || continue
            if grep -qE "(api_key|secret|password|token)\s*=\s*['\"][^'\"]{8,}" "$file" 2>/dev/null; then
              echo "‚ö†Ô∏è  Possible hardcoded secret in: $file"
              ISSUES=$((ISSUES+1))
            fi
          done < /tmp/changed.txt
          if [ $ISSUES -eq 0 ]; then
            echo "‚úÖ No obvious secrets found"
          fi

      - name: Post summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const files = `${{ steps.changed.outputs.files }}`.trim();
            const body = `## ü§ñ Auto Review\n\n**Changed files:** \`${files || 'none'}\`\n\n‚úÖ Linting + security scan complete. Check workflow logs for details.\n\n> CodeRabbit will add a full review if this is a PR.`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
